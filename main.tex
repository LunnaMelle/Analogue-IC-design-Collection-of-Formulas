\documentclass[12pt, a4paper]{article}%
\usepackage[top=4cm, bottom=4cm, left=3cm, right=3cm]{geometry}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{lastpage}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{float}
\usepackage{datetime2}
\usepackage{amsmath}
\allowdisplaybreaks
\usepackage{circuitikz}
\usepackage{import}
\usepackage{hhline}
\usepackage{amssymb}
\usepackage{icomma}
\usepackage{mathtools}
\usepackage{siunitx}

\usepackage{listings}
\usepackage{xcolor} % För färger om du vill ha syntax highlighting

\usepackage{caption}
\usepackage{subcaption}
\captionsetup{labelfont=bf}



\lstdefinestyle{matlabStyle}{
    language=Matlab,
    backgroundcolor=\color{gray!10},
    basicstyle=\ttfamily\footnotesize,
    keywordstyle=\color{blue},
    commentstyle=\color{green!50!black},
    stringstyle=\color{red},
    numbers=left,
    numberstyle=\tiny\color{gray},
    stepnumber=1,
    numbersep=5pt,
    breaklines=true,
    showstringspaces=false,
    captionpos=b
}
\lstset{style=matlabStyle}



\newcommand{\degree}{\ensuremath{^\circ}}


% ieee referatsystem
% \usepackage[backend=biber, style=ieee]{biblatex}
% \addbibresource{referenser.bib}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.75em}

% Hyperref should be loaded last
\usepackage{bookmark}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=black,
    urlcolor=blue,
    citecolor=blue
}

% Header setup
\pagestyle{fancy}
\fancyhead[R]{Analogue IC-design ETIN25 \hspace{1em} \thepage/\pageref{LastPage}}
\fancyfoot{}

\setlength{\headheight}{14.5pt} % Fix fancyhdr warning
\setcounter{secnumdepth}{0} % Only number up to subsections

\begin{document}

\begin{titlepage}
    \centering
    
    \vspace{8cm}
    
    % Titel
{\Huge \selectfont\bfseries Collection of Formulas \\ and Compendium \par}

    \vspace{1cm}

    {\Large Analogue IC-design ETIN25}
    
    \vfill

    \includegraphics[width=0.5\textwidth]{pictures/Sigill_Lunds_universitet_(vit).png}\par

    {\textit{ \textbf{OBS!! Work in progress \\ Made by student Melker Rose E23}}}
    
    {\textit{Department of Electrical and Information Technology \\ Faculty of Engineering LTH \\ Lund University, Sweden \\ \DTMtoday}}

    \vspace{1cm}

    
\end{titlepage}

\thispagestyle{fancy}
\setcounter{page}{2}

\newpage

\section*{Preface}
This collection of formulas and compendium is an unofficial document created by me, a student (Melker Rose E23), for the course Analogue IC-design (ETIN25) at LTH. 

The primary purposes of creating this document were:
\begin{itemize}
    \item To gather all relevant formulas, method and more in one convenient location for study and reference
    \item To enhance learning through the process of organizing and typesetting the material
\end{itemize}

\textbf{Important notes:}
\begin{itemize}
    \item This is \emph{not} an official document from the course administration, department, or faculty
    \item Although care has been taken to ensure accuracy and formulas are primarily sourced from official materials, the coursebook (\textbf{Gray, Hurst, Lewis, Meyer:} \textit{Analysis and Design of Analog Integrated Circuits}, Fifth Edition. Wiley 2010.) and/or lecture slides, cross-referencing is recommended, as there may be errors or omissions
    \item This document is a work in progress and may be updated
\end{itemize}

I hope this document proves useful. \\ Best of luck, 

\textbf{\textit{Melker Rose} \hfill \textit{\DTMtoday}}

\newpage

\tableofcontents

\newpage

\section{Formulas}

\subsection{General formulas}
\begin{flalign}
\parbox{4.5cm}{Transconductance} 
& \quad G_m = \frac{i_o}{v_i} \Bigg|_{v_o=0} &&\\[4pt]
%
\parbox{4.5cm}{Input resistance\\(with test source)} 
& \quad R_i = \frac{v_t}{i_t} \Bigg|_{v_o=0} &&\\[4pt]
%
\parbox{4.5cm}{Output resistance\\(with test source)} 
& \quad R_o = \frac{v_t}{i_t} \Bigg|_{v_i=0} &&\\[4pt]
%
\parbox{4.5cm}{Voltage gain} 
& \quad A_v = G_mR_o &&\\[4pt]
%
\parbox{4.5cm}{Offset Voltage of the\\Source-Coupled Pair} 
& \quad V_{OS} = \Delta V_t + \frac{(V_{GS} - V_t)}{2} \left( -\frac{\Delta R_L}{R_L} - \frac{\Delta (W/L)}{(W/L)} \right) &&
\end{flalign}

\subsection{\textit{npn} Bipolar Transistor Parameters}

\subsubsection{Large-Signal Forward-Active Operation}

\begin{flalign}
\parbox{4.5cm}{Collector current} 
& \quad I_C = I_S \exp\left(\frac{V_{be}}{V_T}\right) &&
\end{flalign}

\subsubsection{Small-Signal Forward-Active Operation}

\begin{flalign}
\parbox{4.5cm}{Transconductance} 
& \quad g_m = \frac{qI_C}{kT} = \frac{I_C}{V_T} &&\\[4pt]
%
\parbox{4.5cm}{Transconductance-to-current ratio} 
& \quad \frac{g_m}{I_C} = \frac{1}{V_T} &&\\[4pt]
%
\parbox{4.5cm}{Input resistance} 
& \quad r_\pi = \frac{\beta_0}{g_m} &&\\[4pt]
%
\parbox{4.5cm}{Output resistance} 
& \quad r_o = \frac{V_A}{I_C} = \frac{1}{\eta g_m} &&\\[4pt]
%
\parbox{4.5cm}{Collector-base resistance} 
& \quad r_\mu = \beta_0 r_o \text{ to } 5\beta_0 r_o &&\\[4pt]
%
\parbox{4.5cm}{Base-charging capacitance} 
& \quad C_b = \tau_F g_m &&\\[4pt]
%
\parbox{4.5cm}{Base-emitter capacitance} 
& \quad C_\pi = C_b + C_{je} &&\\[4pt]
%
\parbox{4.5cm}{Emitter-base junction depletion capacitance} 
& \quad C_{je} \simeq 2C_{je0} &&\\[4pt]
%
\parbox{4.5cm}{Collector-base\\junction capacitance} 
& \quad C_{\mu} = \frac{C_{\mu 0}}{\left(1 - \frac{V_{BC}}{\psi_{0c}}\right)^{n_c}} &&\\[4pt]
%
\parbox{4.5cm}{Collector-substrate\\junction capacitance} 
& \quad C_{cs} = \frac{C_{cs 0}}{\left(1 - \frac{V_{SC}}{\psi_{0s}}\right)^{n_s}} &&\\[4pt]
%
\parbox{4.5cm}{Transition\\frequency} 
& \quad f_T = \frac{1}{2\pi}\frac{g_m}{C_x + C_{\mu}} &&\\[4pt]
%
\parbox{4.5cm}{Effective\\transit time} 
& \quad \tau_T = \frac{1}{2\pi f_T} = \tau_F + \frac{C_{je}}{g_m} + \frac{C_{\mu}}{g_m} &&\\[4pt]
%
\parbox{4.5cm}{Maximum\\gain} 
& \quad g_m r_o = \frac{V_A}{V_T} = \frac{1}{\eta} &&
\end{flalign}

\subsection{NMOS Transistor Parameters}

\subsubsection{Large-Signal Operation}

\begin{flalign}
\parbox{4.5cm}{Process transconductance parameter} 
& \quad k' = \mu C_{ox} &&\\[4pt]
%
\parbox{4.5cm}{Drain current (active region)} 
& \quad I_D = \frac{k'}{2}\frac{W}{L}(V_{GS} - V_t)^2 &&\\[4pt]
%
\parbox{4.5cm}{Overdrive voltage (active region)} 
& \quad V_{OV} = V_{GS} - V_t = \sqrt{\frac{I_D}{\frac{k'}{2}}\frac{W}{L}}  &&\\[4pt]
%
\parbox{4.5cm}{Early voltage} 
& \quad V_A = \frac{I_D}{\delta I_D / \delta V_{DS}} = L_{eff} \left( \frac{\delta X_d}{\delta V_{DS}} \right)^{-1} &&\\[4pt]
%
\parbox{4.5cm}{Reciprocal of the Early voltage} 
& \quad \lambda = \frac{1}{V_A} &&\\[4pt]
%
\parbox{4.5cm}{Drain current (active region) better} 
& \quad I_D = \frac{k'}{2}\frac{W}{L}(V_{GS} - V_t)^2(1+\lambda V_{DS}) &&\\[4pt]
%
\parbox{4.5cm}{Drain current (triode region)} 
& \quad I_D = \frac{k'}{2}\frac{W}{L}\left[2(V_{GS}-V_t)V_{DS} - V_{DS}^2\right] &&\\[4pt]
%
\parbox{4.5cm}{Characteristic current} 
& \quad I_t = qXD_n n_{po} \exp\left(\frac{k_2}{V_T}\right) &&\\[4pt]
%
\parbox{4.5cm}{Drain current\\ (subthreshold region)} 
& \quad I_D = \frac{W}{L} I_t \exp\left(\frac{V_{GS} - V_t}{nV_T}\right) \left[1 - \exp\left(-\frac{V_{DS}}{V_T}\right)\right] &&\\[4pt]
%
\parbox{4.5cm}{Threshold voltage}
& \quad V_t = V_{t0} + \gamma\left[\sqrt{2\phi_f + V_{SB}} - \sqrt{2\phi_f}\right] &&\\[4pt]
%
\parbox{4.5cm}{Threshold voltage parameter}
& \quad \gamma = \frac{1}{C_{ox}}\sqrt{2 q \varepsilon N_A} &&\\[4pt]
%
\parbox{4.5cm}{Oxide capacitance}
& \quad C_{ox} = \frac{\varepsilon_{ox}}{t_{ox}} 
= 3.45\,\text{fF}/\mu\text{m}^2 \quad \text{for } t_{ox}=100\,\text{\AA} &&
\end{flalign}

\subsubsection{Small-Signal Operation (Active Region)}

\begin{flalign}
\parbox{4.5cm}{Top-gate\\transconductance} 
& \quad g_m = \frac{\delta I_D}{\delta V_{GS}} = k'\frac{W}{L}(V_{GS}-V_t) = \sqrt{2 I_D k'\frac{W}{L}} &&\\[4pt]
%
\parbox{4.5cm}{Transconductance-to-\\current ratio} 
& \quad \frac{g_m}{I_D} = \frac{2}{V_{GS}-V_t} &&\\[4pt]
%
\parbox{4.5cm}{Body-effect\\transconductance} 
& \quad g_{mb} = \frac{\gamma}{2\sqrt{2\phi_f + V_{SB}}}g_m = \chi g_m &&\\[4pt]
%
\parbox{4.5cm}{Channel-length\\modulation parameter} 
& \quad \lambda = \frac{1}{V_A} = \frac{1}{L_\text{eff}}\,\frac{dX_d}{dV_{DS}} &&\\[4pt]
%
\parbox{4.5cm}{Output\\resistance} 
& \quad r_o = \frac{1}{\lambda I_D} = \frac{L_{\text{eff}}}{I_D} \left( \frac{dX_d}{dV_{DS}} \right)^{-1} &&\\[4pt]
%
\parbox{4.5cm}{Effective channel\\length} 
& \quad L_{\text{eff}} = L_{\text{down}} - 2L_d - X_d &&\\[4pt]
%
\parbox{4.5cm}{Maximum\\gain} 
& \quad g_m r_o = \frac{1}{\lambda} \frac{2}{V_{GS} - V_i} = \frac{2V_A}{V_{GS} - V_i} &&\\[4pt]
%
\parbox{4.5cm}{Source-body\\depletion capacitance} 
& \quad C_{sb} = \frac{C_{s0}}{\left( 1 + \frac{V_{SB}}{\psi_0} \right)^{0.5}} &&\\[4pt]
%
\parbox{4.5cm}{Drain-body\\depletion capacitance} 
& \quad C_{db} = \frac{C_{db0}}{\left( 1 + \frac{V_{DB}}{\psi_0} \right)^{0.5}} &&\\[4pt]
%
\parbox{4.5cm}{Gate-source\\capacitance} 
& \quad C_{gs} = \frac{2}{3} WL C_{ox} + (C_{gd}) &&\\[4pt]
%
\parbox{4.5cm}{Gate-drain\\capacitance} 
& \quad C_{gd} = W C_{ol} &&\\[4pt]
%
\parbox{4.5cm}{Transition\\frequency} 
& \quad f_T = \frac{g_m}{2\pi (C_{gs} + C_{sd} + C_{gb})} &&\\[4pt]
%
\parbox{4.5cm}{Miller\\capacitance} 
& \quad C_M = (1-A_V)C_{gd} &&
%
\end{flalign}

\subsection{Frequency}
\begin{flalign}
\parbox{4.5cm}{-$3$dB frequency} 
& \quad f_{-3\text{dB}} = \frac{\omega_{-3\text{dB}}}{2\pi} = \frac{|p_1|}{2\pi} \approx  \frac{1}{2\pi \sum_{\forall i} \tau_i} = \frac{1}{2\pi \sum_{\forall i} R_{i0}C_i}  &&\\[4pt]
%
\parbox{4.5cm}{A\% to B\% rise time} 
& \quad t_{r} = \frac{\ln \left( \frac{B\%}{A\%} \right)}{2\pi} \frac{1}{f_{-3\text{dB}}} &&\\[4pt]
\end{flalign}


\begin{flalign}
\parbox{4.5cm}{Example\\example} 
& \quad A = \frac{B}{C} &&\\[4pt]
\end{flalign}

\begin{figure}[H]
    \centering
    \input{circuits/CS-stage} % Inserts the LaTeX file
    \caption{Common-source amplifier stage}
    \label{fig:CS-stage}
\end{figure}

\section{Amplifying stages}

\subsection{Single transistor amplifying stages}

\subsubsection{Common source (MOSFET)}

\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.45\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Resistively loaded common source.png}
    \caption{Resistively loaded, common-source amplifier}
    \label{fig:Resistively loaded, common-source amplifier}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/small signal eq common source.png}
    \caption{Low frequency small-signal equivalent circuit for the
common-source amplifier}
    \label{fig:small signal eq common source}
  \end{subfigure}
  \caption{Common-source amplifier}
  \label{fig:Common-source stage (MOSFET)}
\end{figure}

The transconductance of the CS amplifier can be expressed as:
\begin{equation}
G_m = \frac{i_o}{v_i} \bigg|_{v_o = 0} = g_m
\end{equation}
The (small signal) input resistance \( R_i \) is
\begin{equation}
R_i = \frac{v_i}{i_i} \to \infty
\end{equation}
The output resistance is
\begin{equation}
R_o = \frac{v_o}{i_o} \bigg|_{v_i = 0} = R_D \parallel r_o
\end{equation}
The open-circuit, or unloaded, voltage gain is
\begin{equation}
a_v = \frac{v_o}{v_i} \bigg|_{i_o = 0} = -g_m(r_o \parallel R_D)
\end{equation}

If the drain load resistor \( R_D \) is replaced by a current source, \( R_D \to \infty \) and \( a_v \) becomes

\begin{equation}
\lim_{R_D \to \infty} a_v = -g_mr_o
\end{equation}

\subsubsection{Common gate (MOSFET)}
\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.45\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Common gate.png}
    \caption{Common-gate configuration}
    \label{fig:Common gate}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.5\textwidth}
    \centering
    \input{circuits/test}
    \caption{Low frequency small-signal equivalent circuit for the
common-gate stage}
    \label{fig:Small signal common gate}
  \end{subfigure}
  \caption{Common-gate stage}
  \label{fig:Common-gate stage (MOSFET)}
\end{figure}
The transconductance of the CG-stage can be expressed as:
\begin{equation}
G_m = \frac{i_o}{v_i} = g_m + g_{mb} + \frac{1}{r_o} \approx g_m + g_{mb}
\end{equation}
The output resistance
\begin{equation}
R_o = \frac{v_o}{i_o} = r_o \parallel R_D
\end{equation}
The open-circuit voltage
\begin{equation}
A_v = \frac{v_o}{v_i} = +\left(g_m + g_{mb}\right)\left(r_o \parallel R_D\right) \xrightarrow[r_o \gg R_D]{} \left(g_m + g_{mb}\right)R_D
\end{equation}
The input resistance can be expressed as
\begin{equation}
R_i = \frac{v_i}{i_i} = \frac{R_D + r_o}{1 + \left( g_m + g_{mb} \right) r_o}
\end{equation}
which if \( r_o >> R_D\) and \(g_mr_o >> 1\) then becomes
\begin{equation}
R_i \approx \frac{1}{g_m + g_{mb}} \approx \frac{1}{g_m}
\end{equation}

\subsubsection{Common Drain (MOSFET)}
\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.39\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Common-drain configuration.png}
    \caption{Common-drain configuration}
    \label{fig:Common drain}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.6\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Small signal common drain config.png}
    \caption{Small-signal
equivalent circuit of the common-drain configuration}
    \label{fig:Small signal common drain config}
  \end{subfigure}
  \caption{Common-drain stage also called source follower}
  \label{fig:Common-drain stage (MOSFET)}
\end{figure}

The transconductance of the CD-stage can be expressed as:
\begin{equation}
    G_m = g_m
\end{equation}
and the output resistance
\begin{equation}
R_o = \frac{v_o}{i_o} = \frac{1}{g_m + g_{mb} + \frac{1}{r_o} + \frac{1}{R_L}}
\end{equation}
Which then gives
\begin{equation}
A_v = \frac{g_m}{g_m + g_{mb} + \frac{1}{R_L} + \frac{1}{r_o}} = \frac{g_m R_L}{1 + \left( g_m + g_{mb} \right) R_L + \frac{R_L}{r_o}} < 1
\end{equation}
The input resistance (small-signal) is \(R_i = \infty\)

\subsubsection{Common source with source degeneration (MOSFET)}
\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.39\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Common-source amp with source degeneration.png}
    \caption{Common-source amplifier with source degeneration}
    \label{fig:Common-source amp with source degeneration}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.6\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Small signal common-source amp with source degeneration.png}
    \caption{Small-signal equivalent of the source-degenerated, common-source amplifier}
    \label{fig:Small signal common-source amp with source degeneration}
  \end{subfigure}
  \caption{Source-degenerated, common-source amplifier}
  \label{fig:Common-source source degenerated (MOSFET)}
\end{figure}

The transconductance of the source-degenerated, common-source amplifier can be expressed as:
\begin{equation}
G_m = \frac{i_o}{v_i} = \frac{g_m}{1 + (g_m + g_{mb}) \, R_S + \frac{R_S}{r_o}}
\end{equation}
which if \( r_o \gg R_S \),
\begin{equation}
G_m \simeq \frac{g_m}{1 + (g_m + g_{mb}) \, R_S}
\end{equation}
The output resistance becomes
\begin{equation}
R_o = \frac{v_t}{i_t} = R_S + r_o \left[ 1 + (g_m + g_{mb}) R_S \right]
\end{equation}

\subsection{Multiple transistor amplifying stages}

\subsubsection{Cascode amplifier (CS-CG)}
\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/cascode amplifier using mosfet.png}
    \caption{Cascode amplifier using MOSFET (CS-CG)}
    \label{fig:Common-source amp with source degeneration}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Small signal ew of cascode amp using mosfet.png}
    \caption{Small-signal equivalent circuit for the MOS-transistor cascode connection}
    \label{fig:Small signal common-source amp with source degeneration}
  \end{subfigure}
  \caption{CS-stage followed by CG-stage cascode amplifier}
  \label{fig:Common-source source degenerated (MOSFET)}
\end{figure}
The output resistance of the CS-CG cascode amplifier can be written as
\begin{equation}
R_o = r_{o1} + r_{o2} + \left( g_{m2} + g_{mb2} \right) r_{o1} r_{o2}
\label{ro cs cg}
\end{equation}
From the expression of the CG input impedance, we get:
\begin{equation}
R_{i2} = \frac{r_{o2} + R}{1 + (g_{m2} + g_{m2})r_{o2}} \approx \frac{1}{g_{m2} + g_{m2}} + \frac{R}{(g_{m2} + g_{m2})r_{o2}} \ll r_{o1}
\end{equation}
from which the transconductance can be calculated to
\begin{align}
G_m &= \frac{i}{v_i} \bigg|_{i=0} = g_{m1} \left. \frac{r_{o1}}{r_{o1} + R_{i2}} \right|_{R=0} = g_{m1} \left( 1 - \frac{\frac{r_{o2}}{1 + (g_{m2} + g_{m2})r_{o2}}}{r_{o1} +\frac{r_{o2}}{1 + (g_{m2} + g_{m2})r_{o2}}} \right) \\ 
&\approx g_{m1} \left( 1 - \frac{r_{o2}}{r_{o1} + r_{o2} + (g_{m2} + g_{m2})r_{o1}r_{o2}} \right) \approx g_{m1}
\label{gm cscg}
\end{align}
Using \eqref{ro cs cg} and \eqref{gm cscg} then the  gives
\begin{align}
    A_v &= -G_m (R_{o} \parallel R) \approx -g_{m1} \left[ \left( r_{o1} + r_{o2} + (g_{m2} + g_{mb2}) r_{o1} r_{o2} \right) \parallel R \right] \\ 
    &\approx -g_{m1} R
\end{align}

\subsubsection{Source-coupled differential pair}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\linewidth]{pictures/n-channel MOSFET source-coupled pair.png}
    \caption{n-channel MOSFET source-coupled pair}
    \label{fig:n-channel MOSFET source-coupled pair}
\end{figure}
The two input signals to a differential amplifier are very often described in terms of differential signals and common-mode signals.

Differential-mode gain:
\begin{equation}
A_{dm} = \frac{v_{od}}{v_{id}} \bigg|_{v_{ic}=0}
\end{equation}
Common-mode gain:
\begin{equation}
A_{cm} = \frac{v_{oc}}{v_{ic}} \bigg|_{v_{id}=0}
\end{equation}
Common-mode to differential-mode:
\begin{equation}
A_{cm-dm} = \frac{v_{od}}{v_{ic}} \bigg|_{v_{id}=0}
\end{equation}
Differential-mode to common-mode:
\begin{equation}
A_{dm-cm} = \frac{v_{oc}}{v_{id}} \bigg|_{v_{ic}=0}
\end{equation}
Ideally we want
\begin{equation}
A_{dm} = \infty \quad \text{and} \quad A_{cm} = A_{cm-dm} = A_{dm-cm} = 0
\end{equation}
The common-mode rejection ratio (CMRR):
\begin{equation}
CMRR = \frac{A_{dm}}{A_{cm}}
\end{equation}

\subsubsection{Pure differential mode differentiral pair}
\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Small-signal equivalent circuit for differential pair with pure differential-mode input..png}
    \caption{Very ideal small-signal equivalent circuit for differential pair with pure differential-mode input}
    \label{fig:Small-signal equivalent circuit for differential pair with pure differential-mode input}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/differential-mode half circuit.png}
    \caption{Differential-mode half circuit}
    \label{fig:differential-mode half circuit}
  \end{subfigure}
  \caption{Pure differential mode differentiral pair. Because of symmetry, no voltage across \(R_{TAIL}\) $\rightarrow$ the common source does not move $\rightarrow$ it is at “signal ground”. Again because of symmetry, it is enough to analyze only one half of the differential circuit}
  \label{fig:Common-source source degenerated (MOSFET)}
\end{figure}
From Fig. \ref{fig:differential-mode half circuit} it can be seen
\begin{equation}
\frac{v_{od}}{2} = -g_m R \frac{v_{id}}{2}
\end{equation}
which then gives
\begin{equation}
A_{dm} = \left. \frac{v_{od}}{v_{id}} \right|_{v_{ic} = 0} = -g_m R
\end{equation}

To include the output resistance of the transistor in the above analysis, $R$ should be replaced by $R \parallel r_o$. Finally, note that neglecting $g_{mb}$ from this analysis for MOS source-coupled pairs has no effect on the result because the voltage from the source to the body of the input transistors is the same as the voltage across the tail current source, which is constant with a pure differential input.

\subsubsection{Pure common mode differentiral pair}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.4\linewidth]{pictures/Source-coupled pair with pure common mode input.png}
    \caption{Source-coupled pair with pure common mode input}
    \label{fig:Source-coupled pair with pure common mode input}
\end{figure}

\begin{figure}[H]
  \centering
  % First Subfigure
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Small-signal eq pure common mode input.png}
    \caption{Small-signal equivalent pure common mode input}
    \label{fig:Small-signal eq pure common mode input}
  \end{subfigure}
  \hfill
  % Second Subfigure
  \begin{subfigure}{0.49\textwidth}
    \centering
    \includegraphics[width=\linewidth]{pictures/Common mode half circuit.png}
    \caption{Common mode half circuit}
    \label{fig:Common mode half circuit}
  \end{subfigure}
  \caption{Pure common mode differentiral pair. Because of symmetry, no current across \(i_x\) $\rightarrow$ enough to analyze only one half of the differential circuit}
  \label{fig:Common-source source degenerated (MOSFET)}
\end{figure}
The gain of CS stage with source degeneration ($g_{mb}$ not included in circuit):  
\begin{equation}
A_{cm} \approx -\frac{g_m R}{1 + 2 \left( g_m + g_{mb} \right) R_{TAIL}}
\end{equation}
Again, to include the output resistance of the transistor $R$ should be replaced by $R \parallel r_o$. Thus the common-mode rejection ratio (CMRR) can be calculated to
\begin{equation}
CMRR = \left| \frac{A_{dm}}{A_{cm}} \right| = \frac{g_m R}{\dfrac{g_m R}{1 + 2 \left( g_m + g_{mb} \right) R_{TAIL}}} = 1 + 2 \left( g_m + g_{mb} \right) R_{TAIL}
\end{equation}
\textit{OBS!} CMRR may be quite high at low frequencies.

\section{Methods}

\subsection{Dominant-Pole Approximation}

For any electronic circuit, a transfer function can be derived
\begin{equation}
A(s) = \frac{a_0 + a_1 s + a_2 s^2 + \cdots + a_m s^m}{1 + b_1 s + b_2 s^2 + \cdots + b_n s^n}
\end{equation}
this can be factored into
\begin{equation}
    A(s) = K \frac{\left( 1 - \frac{s}{n_1} \right) \left( 1 - \frac{s}{n_2} \right) \cdots \left( 1 - \frac{s}{n_m} \right)}{\left( 1 - \frac{s}{p_1} \right) \left( 1 - \frac{s}{p_2} \right) \cdots \left( 1 - \frac{s}{p_n} \right)} 
\end{equation}
where \( K \) is a constant, \(n_i\) are the zeros, and \( p_i\) are the poles of the transfer function and
\begin{equation}
b_1 = \sum_{i=1}^n \left( -\frac{1}{p_i} \right)
\end{equation}
When one pole is dominant, i.e
\begin{equation}
|p_1| \ll |p_2|, |p_3|, \ldots \quad \text{so that} \quad \left| \frac{1}{p_1} \right| \gg \left| \sum_{i=2}^n \left( -\frac{1}{p_i} \right) \right|
\end{equation}
it can be shown that
\begin{equation}
b_1 \simeq \left| \frac{1}{p_1} \right|
\end{equation}

\subsubsection{Open-circuit (zero-value) time-constant}
An approximation of \(b_1\) is 
\begin{align}
b_{1}=\sum_{i=1}^{n}\tau_{i}=\sum_{i=1}^{n}R_{i0}C_{i}
\end{align}
where $R_{i0}$ is the resistance seen by $C_i$ (i.e., with $C_i$ working as a voltage or current source) when all other capacitors are removed (open circuits, zeroed), and all independent voltage and current sources are zeroed as well; i.e., independent voltage sources become short circuits, and independent current sources become open circuits.

For this the \(-3\text{dB}\) frequency can be estimated as
\begin{equation}
    f_{-3\text{dB}} = \frac{\omega_{-3\text{dB}}}{2\pi} = \frac{|p_1|}{2\pi} \approx \frac{1}{2\pi b_1} = \frac{1}{2\pi \sum_{\forall i} \tau_i}
\end{equation}

\subsubsection{Open-circuit time-constant example}
Calculate the \(-3\text{dB}\) angular frequency of the following circuit (ignore $C_{gb}$)
\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{pictures/Two-stage common-source cascade amplifier.png}
    \caption{Two-stage common-source cascade amplifier}
    \label{fig:Two-stage common-source cascade amplifier}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{pictures/Small-signal equivalent circuit of two-stage common-source cascade amplifier.png}
    \caption{Small-signal equivalent circuit of fig. \ref{fig:Two-stage common-source cascade amplifier}}
    \label{fig:Small-signal equivalent circuit of two-stage common-source cascade amplifier}
\end{figure}

By using the open-circuit time-constant it can be found that
\begin{align}
    \tau_{gd1} &= C_{gd1} R_{gd01} = C_{gd1} (R_S + R_{L1} + g_{m1} R_{L1} R_S) \\
    \tau_{gd2} &=C_{gd2} R_{gd02} = C_{gd2} (R_{L1} + R_{L2} + g_{m2} R_{L2} R_{L1}) \\
    \tau_{gs1} &= C_{gs1} R_{gs01} = C_{gs1} R_S \\
    \tau_{gs2} &= C_{gs2} R_{gs02} = C_{gs1} R_{L1} \\
    \tau_{db1} &= C_{db1} R_{db01} = C_{db1} R_{L1} \\
    \tau_{db2} &= C_{db2} R_{db02} = C_{db2} R_{L2}
\end{align}
for which
\begin{equation}
    b_1 = \sum_{\forall i} \tau_i = \sum_{i=1}^6 \tau_i
\end{equation}
and thus 
\begin{equation}
    \omega_{-3\text{dB}} \approx \frac{1}{b_1} = \frac{1}{\sum_{\forall i} \tau_i}
\end{equation}



\end{document}